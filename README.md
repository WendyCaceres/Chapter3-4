# CAPÍTULO 3: UN MARCO PARA EL DISEÑO DE SISTEMAS ENTREVISTAS

Acaba de conseguir una codiciada entrevista en la empresa de sus sueños.
El coordinador de contratación le envía un horario para ese día. Al hojear
la lista, se siente bastante bien hasta que sus ojos se posan en esta sesión de
sesión - Entrevista de diseño de sistemas.


Las entrevistas de diseño de sistemas suelen ser intimidantes. Puede ser algo tan vago como "¿Diseñar un producto X muy conocido?". Las preguntas son ambiguas yparecen irrazonablemente amplias. Tu cansancio es comprensible. Después de todo, ¿cómo puede alguien diseñar en una hora un producto popular que ha llevado cientos si no miles de ingenieros?


La buena noticia es que nadie espera que lo hagas. El diseño de sistemas en el mundo real es extremadamente complicado. Por ejemplo, la búsqueda de Google es engañosamente simple; sin embargo, la cantidad de tecnología que sustenta esa simplicidad es realmenteasombrosa. Si nadie espera que diseñes un sistema del mundo real en una hora, ¿cuál es la ventaja de una entrevista de diseño de sistemas?


La entrevista de diseño de sistemas simula la resolución de problemas de la vida real, en la que dos compañeros de trabajo colaboran en un problema ambiguo y llegan a una solución que cumpla sus objetivos. El problema es abierto y no hay una respuesta perfecta. El diseño final es menos importante que el trabajo realizado en el proceso de diseño. Esto le permitirá demostrar sus habilidades de diseño, defender tus decisiones de diseño y responder a los comentarios de forma constructiva.


Demos la vuelta a la tortilla y pensemos en lo que pasa por la cabeza de la entrevistadora cuando entra en la sala de conferencias para conocerte. El objetivo principal de la entrevistador es evaluar con precisión tus capacidades. Lo último que quiere es dar una evaluación poco concluyente porque la sesión ha ido mal y no hay suficientes señales. ¿Qué busca un entrevistador en una entrevista de entrevista de diseño de sistemas?


Muchos creen que la entrevista de diseño de sistemas se centra en las habilidades técnicas de diseño de una persona. Es mucho más que eso. Una entrevista de diseño de sistemas eficaz da señales claras sobre la capacidad de una persona para colaborar, trabajar bajo presión y resolver la ambigüedad de forma constructiva.La capacidad de hacer buenas preguntas también es esencial, y muchos entrevistadores buscan específicamente esta habilidad.


Un buen entrevistador también busca señales de alarma. El exceso de ingeniería es una enfermedad de muchos ingenieros, que se deleitan en la pureza del diseño e ignoran las compensaciones. A menudo no son conscientes de los costes de los sistemas sobredimensionados, y muchas empresas pagan un alto precio por esa ignorancia.Desde luego, no querrá demostrar esta tendencia en una entrevista de diseño de sistemas. Otras señales de alarma son la estrechez de miras,
terquedad, etc.


En este capítulo, repasaremos algunos consejos útiles y presentaremos un marco sencillo y eficaz para resolver los problemas de las entrevistas de diseño de sistemas.


## Un proceso de 4 pasos para una entrevista entrevista


Cada entrevista de diseño de sistemas es diferente. Una buena entrevista de diseño de sistemas es abierta y no existe una solución única. Sin embargo, hay
pasos y puntos en común que deben cubrirse en todas las entrevistas de diseño de sistemas.


## Paso 1 - Entender el problema y establecer el alcance del diseño


"¿Por qué ha rugido el tigre?

Una mano se levantó en el fondo de la clase.

"¿Sí, Jimmy?", respondió el profesor.

"Porque tenía HAMBRE".

"Muy bien Jimmy".

Durante toda su infancia, Jimmy siempre ha sido el primero en contestar
preguntas en la clase. Cada vez que el profesor hace una pregunta, siempre hay un niño en el aula al que le encanta responder a la pregunta, sin
no importa si sabe la respuesta o no. Ese es Jimmy.


Jimmy es un gran estudiante. Se enorgullece de saber todas las respuestas rápidamente. En exámenes, suele ser la primera persona en terminar las preguntas. Es la opción preferida por los profesores para cualquier competencia académica.


NO seas como Jimmy.


En una entrevista de diseño de sistemas, dar una respuesta rápidamente sin pensar no te da puntos extra. Responder sin comprender a fondo
los requisitos es una gran señal de alarma, ya que la entrevista no es un concurso de trivialidades. No hay una respuesta correcta.


Por lo tanto, no te lances a dar una solución. Ve más despacio. Reflexione profundamente y haga preguntas para aclarar los requisitos y suposiciones. Esto es sumamente importante.


Como ingenieros, nos gusta resolver problemas difíciles y lanzarnos al diseño final; sin embargo, es probable que este enfoque le lleve a diseñar el sistema equivocado. Una de las habilidades más importantes de un ingeniero es hacer las preguntas correctas, hacer las suposiciones adecuadas y reunir toda la información necesaria para construir un sistema. Por lo tanto, no tengas miedo de hacer preguntas.

Cuando haces una pregunta, el entrevistador puede responder directamente o pedirte que hagas tus suposiciones. En este último caso, anota
en la pizarra o en un papel. Puede que las necesites más adelante.

¿Qué tipo de preguntas hacer? Haga preguntas para entender exactamente
requisitos exactos. Aquí tienes una lista de preguntas que te ayudarán a empezar:

- ¿Qué funciones específicas vamos a crear?

- ¿Cuántos usuarios tiene el producto?

- ¿Cuál es la velocidad de crecimiento prevista por la empresa? 
¿Cuáles son las escalas previstas en 3 meses, 6 meses y un año?

- ¿Cuál es la pila tecnológica de la empresa? ¿Qué servicios existentes
para simplificar el diseño?

## Ejemplo

Si le piden que diseñe un sistema de noticias, debe hacer preguntas que le ayuden a aclarar los requisitos.La conversación entre usted y
entrevistador podría ser la siguiente:

Candidato: ¿Se trata de una aplicación móvil? ¿O una aplicación web? ¿O ambas?

Entrevistador: Ambas.

Candidato: ¿Cuáles son las características más importantes del producto?

Entrevistador: La posibilidad de publicar y ver las noticias de tus amigos.

Candidato: ¿Las noticias están ordenadas en orden cronológico inverso o en un
particular? El orden particular significa que cada publicación se le asigna un peso diferente. Por ejemplo, las publicaciones de tus amigos cercanos son más importantes que las publicaciones de un grupo.

Entrevistador: Para simplificar las cosas, supongamos que el feed está ordenado por orden cronológico inverso.

Candidato: ¿Cuántos amigos puede tener un usuario?

Entrevistador: 5000

Candidato: ¿Cuál es el volumen de tráfico?

Entrevistador: 10 millones de usuarios activos diarios (DAU)

Candidato: ¿El feed puede contener imágenes, vídeos o sólo texto?

Entrevistador: Puede contener archivos multimedia, tanto imágenes como vídeos.

Como se mostraron algunas preguntas de ejemplo que puedes hacerle a tu entrevistador. Es importante comprender los requisitos y aclarar ambigüedades.

# Paso 2 - Proponer un diseño de alto nivel y conseguir su aceptación

En este paso, nuestro objetivo es desarrollar un diseño de alto nivel y llegar a un acuerdo con el entrevistador sobre el diseño. Es una buena idea colaborar con el
entrevistador durante el proceso.

- Elabore un plan inicial para el diseño. Pedir opiniones. Trate
a su entrevistador como a un compañero de equipo y trabajen juntos. A muchos buenos entrevistadores les encanta hablar y participar.
- Dibuja diagramas de caja con los componentes clave en la pizarra o en papel. Este
puede incluir clientes (móvil/web), API, servidores web, almacenes de datos, caché,
CDN, cola de mensajes, etc.
- Haz cálculos para evaluar si tu proyecto se ajusta a las restricciones de escala.
limitaciones de escala. Piensa en voz alta. Comunique a su entrevistador si
con su entrevistador si es necesario realizar cálculos retrospectivos.

Si es posible, repasa algunos casos de uso concretos. Esto le ayudará a enmarcar
el diseño de alto nivel. También es probable que los casos de uso le ayuden a
descubrir casos extremos que aún no ha considerado.

¿Deberíamos incluir aquí los puntos finales de la API y el esquema de la base de datos? Esto depende del problema. Para grandes problemas de diseño como "Diseñar el motor de búsqueda de Google", esto es un poco de nivel demasiado bajo. Para un problema como diseñar el backend para un juego de poker multijugador, esto es un juego justo. Comunique
con tu entrevistador.

# Ejemplo

Utilicemos "Diseñar un sistema de noticias" para demostrar cómo enfocar
el diseño de alto nivel. En este caso no es necesario que entienda
cómo funciona realmente el sistema. Todos los detalles se explicarán en el capítulo 11.

A alto nivel, el diseño se divide en dos flujos: publicación de feeds y creación de feeds de noticias.

- Publicación de feeds: cuando un usuario publica una publicación, se muestran los datos correspondientes escritos en el caché/base de datos, y la publicación se completará en la lista de amigos
  
- Construcción del feed de noticias: el feed de noticias se construye agregando las publicaciones de los amigos en orden cronológico inverso.

La Figura 3-1 y la Figura 3-2 presentan diseños de alto nivel para la publicación de feeds de noticias, respectivamente.

(Imagen)Primer plano de un mapa Descripción generada automáticamente

(Imagen)Primer plano de un logotipo Descripción generada automáticamente

# Paso 3 - Profundización en el diseño

En este paso, usted y su entrevistador ya deberían haber alcanzado los
los siguientes objetivos: 

- Acordar los objetivos generales y el alcance de las funciones.
- Esbozar un plan de alto nivel para el diseño general.
- Haber recibido comentarios del entrevistador sobre el diseño de alto nivel.
- Tener algunas ideas iniciales sobre las áreas en las que centrarse en la inmersión profunda basada en sus comentarios.
  
Trabajará con el entrevistador para identificar y priorizar los componentes
de la arquitectura. Cabe destacar que cada entrevista es diferente.
A veces, la entrevistadora puede dar pistas de que le gusta centrarse en el diseño de alto nivel. A veces, en el caso de una entrevista con un candidato
sobre las características de rendimiento del sistema, probablemente
centrándose en los cuellos de botella y la estimación de recursos. En la mayoría de los casos, el entrevistador puede querer que profundices en los detalles de algunos componentes del sistema. En el caso del acortador de URL, es interesante profundizar en el diseño de la función hash que convierte una URL larga en una corta. Para un sistema de chat, ¿cómo reducir latencia y cómo soportar el estado online/offline son dos temas interesantes.

La gestión del tiempo es esencial, ya que es fácil dejarse llevar por minuciosos
detalles que no demuestran tus habilidades. Debe estar armado con
señales que mostrar a tu entrevistador. Intenta no entrar en detalles innecesarios.
Por ejemplo, hablar en detalle del algoritmo EdgeRank del feed
Facebook no es lo ideal en una entrevista de diseño de sistemas, ya que requiere mucho tiempo y no demuestra tus capacidad para diseñar un sistema escalable.

# Ejemplo

En este punto, hemos discutido el diseño de alto nivel para un sistema de noticias.
y el entrevistador está satisfecho con tu propuesta. A continuación
investigaremos dos de los casos de uso más importantes:

1.  Publicación de noticias
   
2.  Recuperación de noticias
   
Las figuras 3-3 y 3-4 muestran el diseño detallado de los dos casos de uso,
que se explicarán en detalle en el Capítulo 11.

(Imagen) Primer plano de un mapa Descripción generada automáticamente

(Imagen) Primer plano de un mapa Descripción generada automáticamente

# Paso 4 - Conclusión

En este último paso, el entrevistador puede hacerle algunas preguntas de seguimiento
o darle la libertad de comentar otros puntos adicionales. He aquí algunas
instrucciones que debe seguir:

- El entrevistador puede pedirle que identifique los cuellos de botella del sistema y
que comentes posibles mejoras. Nunca diga que su diseño es perfecto y que nada se puede mejorar. Siempre hay algo que mejorar. Esta es una gran oportunidad para mostrar su pensamiento crítico y dejar una buena impresión final.

- Podría ser útil ofrecer al entrevistador una recapitulación de tu diseño. Esto es especialmente importante si has propuesto varias soluciones. Refrescar la memoria del entrevistador puede ser útil después de una larga sesión.

- Es interesante hablar de los casos de error (fallo del servidor, pérdida de red, etc.).
  
- Merece la pena mencionar los problemas operativos. ¿Cómo controla las métricas y
registros de errores? ¿Cómo desplegar el sistema?

- Cómo gestionar la siguiente curva de escala también es un tema interesante. Por ejemplo, si su diseño actual admite 1 millón de usuarios, ¿Qué cambios debe hacer para soportar 10 millones de usuarios?
  
- Proponga otras mejoras que necesitaría si dispusiera de más tiempo.
  
Para terminar, resumimos una lista de lo que hay que hacer y lo que no hay que hacer.

Lo que hay que hacer: 

- Pide siempre aclaraciones. No dé por sentado que sus suposiciones son correctas.
  
- Comprenda los requisitos del problema.
  
- No existe ni la respuesta correcta ni la mejor. Una solución diseñada
para resolver los problemas de una joven startup es diferente de la de una
empresa consolidada con millones de usuarios. Asegúrese de comprender los
requisitos.

- Haga saber al entrevistador lo que está pensando. Comuníquese con su
entrevistador en todo momento.

- Sugiera varios enfoques si es posible.

- Una vez que esté de acuerdo con su entrevistador sobre el plan, entre en detalles sobre cada componente. Diseña primero los componentes más importantes.
  
- Comunique sus ideas al entrevistador. Un buen entrevistador trabajara con usted como
equipo.

- No se rinda nunca.
  
Qué no hacer: 

- Estar mal preparado para las preguntas típicas de las entrevistas.
  
- No te lances a buscar una solución sin aclarar los requisitos y los supuestos.

- No entre en demasiados detalles sobre un solo componente al principio. Presenta primero el diseño de alto nivel y luego ve más allá.
  
- Si te quedas atascado, no dudes en pedir ayuda.
  
- Vuelve a comunicarte. No pienses en silencio.
  
- No creas que has terminado la entrevista una vez que has presentado el diseño. No acabo hasta que tu entrevistador te diga que has terminado. Pida opiniones pronto y a menudo.

# Asignación de tiempo a cada paso

Las preguntas de la entrevista de diseño de sistemas suelen ser muy amplias, y 45 minutos o una hora no bastan para abarcar todo el diseño. La gestión del tiempo es esencial. ¿Cuánto tiempo debe dedicar a cada paso? Lo que sigue es
para distribuir el tiempo en una entrevista de 45 minutos. Recuerde que se trata de una estimación aproximada y que el tiempo real
depende del alcance del problema y de los requisitos del entrevistador.

Paso 1 Comprender el problema y establecer el alcance del diseño: 3 - 10 minutos

Paso 2 Proponer un diseño de alto nivel y conseguir su aceptación: 10 - 15 minutos

Paso 3 Profundizar en el diseño: 10 - 25 minutos

Paso 4 Conclusión: 3 - 5 minutos


# CAPÍTULO 4: DISEÑO DE UN LIMITADOR

En un sistema de red, un limitador de tasa se utiliza para controlar la tasa de tráfico enviado por un cliente o un servicio. En el mundo HTTP, un limitador de tasa limita el número de solicitudes de clientes que se pueden enviar durante un periodo determinado. Si el número de API supera el umbral definido por el limitador de velocidad, todas las
exceso de llamadas se bloquean. He aquí algunos ejemplos:

- Un usuario no puede escribir más de 2 posts por segundo.
  
- Puede crear un máximo de 10 cuentas al día desde la misma dirección IP.
  
- No se pueden reclamar recompensas más de 5 veces por semana desde el mismo dispositivo.
mismo dispositivo.

En este capítulo, se le pide que diseñe un limitador de velocidad. Antes de comenzar el diseño, primero veremos los beneficios de usar un limitador de tasa API:

- Prevenir la inanición de recursos causada por ataques de Denegación de Servicio (DoS) [1]. Casi todas las API publicadas por grandes empresas tecnológicas aplican algún tipo de limitación de velocidad. Por ejemplo, Twitter limita el número de tweets a 300 cada 3
horas [2]. Las API de Google Docs tienen el siguiente límite por defecto: 300 por usuario
por 60 segundos para solicitudes de lectura [3]. Un limitador de velocidad evita los ataques ya sean intencionados o no, bloqueando el exceso de llamadas.

- Reducción de costes. Limitar el exceso de peticiones significa menos servidores y asignar más recursos a las API de alta prioridad. La limitación de la tasa es extremadamente importante para las empresas que utilizan API de terceros de pago. Por ejemplo, se cobra por llamada para las siguientes API externas: comprobar el crédito, realizar un pago, recuperar historiales médicos, etc.Limitar el número de llamadas es
esencial para reducir costes.

- Evitar la sobrecarga de los servidores. Para reducir la carga de los servidores
para filtrar el exceso de peticiones causadas por bots o el mal comportamiento de los
de los usuarios.

# Paso 1 - Comprender el problema y establecer alcance del diseño

El limitador de velocidad puede implementarse utilizando diferentes algoritmos, cada uno con sus pros y contras. Las interacciones entre un entrevistador y un candidato
ayudan a aclarar el tipo de limitador de velocidad que queremos construir.

Candidato: ¿Qué tipo de limitador de velocidad vamos a diseñar? ¿Es un limitador de velocidad del lado del cliente o del lado del servidor?

Entrevistador: Buena pregunta. Nos centraremos en el limitador de velocidad de la API del servidor.

Candidato: ¿El limitador de velocidad estrangula las solicitudes de API basándose en la IP, el ID de usuario u otras propiedades?

Entrevistador: El limitador de velocidad debe ser lo suficientemente flexible para admitir diferentes conjuntos de reglas de limitación.

Candidato: ¿Cuál es la escala del sistema? ¿Está pensado para una nueva empresa o para una empresa con una gran base de usuarios?

Entrevistador: El sistema debe ser capaz de gestionar un gran número de solicitudes.

Candidato: ¿Funcionará el sistema en un entorno distribuido?

Entrevistador: Sí.

Candidato: ¿El limitador de velocidad es un servicio independiente o debe implementarse
en el código de la aplicación?

Entrevistador: Es una decisión de diseño que depende de ti.

Candidato: ¿Tenemos que informar a los usuarios que están limitados?

Entrevistador: Sí.

Requisitos

He aquí un resumen de los requisitos del sistema:

- Limitar con precisión las peticiones excesivas.
  
- Baja latencia. El limitador de velocidad no debe ralentizar el tiempo de respuesta HTTP.
  
- Utilizar la menor cantidad de memoria posible.
  
- Limitación de velocidad distribuida. El limitador de velocidad puede compartirse entre varios servidores o procesos.
  
- Manejo de excepciones. Mostrar excepciones claras a los usuarios cuando sus solicitudes
están estrangulados.

- Alta tolerancia a fallos. Si hay algún problema con el limitador de velocidad (por
ejemplo, un servidor de caché se desconecta), no afecta a todo el sistema.

# Paso 2 - Proponer un diseño de alto nivel y conseguir apoyo
Mantengamos las cosas sencillas y utilicemos un modelo básico de cliente y servidor para la comunicación.

# ¿Dónde colocar el limitador de velocidad?

Intuitivamente, se puede implementar un limitador de velocidad en el cliente o en el servidor.

- Implementación del lado del cliente. En general, el cliente es un lugar poco fiable para imponer la limitación de velocidad porque las peticiones del cliente pueden ser falsificadas por actores maliciosos. Además, es posible que no tengamos control sobre la implementación del cliente.
  
- Implementación del lado del servidor. La Figura 4-1 muestra un limitador de velocidad que se coloca en el lado del servidor.
  
(Imagen) Una imagen que contiene la descripción del reloj generada automáticamente

Además de las implementaciones del lado del cliente y del lado del servidor, existe una alternativa. En lugar de colocar un limitador de velocidad en los servidores API, creamos un middleware limitador, que regula las peticiones a sus API, como se muestra en la Figura 4-2.

(Captura) Captura de pantalla de un teléfono móvil Descripción generada automáticamente

Utilicemos un ejemplo de la Figura 4-3 para ilustrar cómo funciona la limitación de velocidad en este diseño. Supongamos que nuestra API permite 2 solicitudes por segundo, y un cliente envía 3 peticiones al servidor en un segundo. Las dos primeras
enrutadas a los servidores API. Sin embargo, el middleware limitador de velocidad estrangula la tercera solicitud y devuelve un código de estado HTTP 429. La respuesta HTTP 429 indica que el usuario ha enviado demasiadas solicitudes.

(Captura) Captura de pantalla de un teléfono móvil Descripción generada automáticamente

Los microservicios en la nube [4] se han hecho muy populares y la limitación de la tasa se suele implementarse en un componente llamado pasarela API. La pasarela API
es un servicio totalmente gestionado que soporta limitación de tasa, terminación SSL
autenticación, listas blancas de IP, servicio de contenido estático, etc. Por ahora, sólo necesitamos saber que la pasarela API es un middleware que admite la limitación de velocidad.

Al diseñar un limitador de velocidad, una pregunta importante que debemos hacernos es:
¿dónde debe implementarse el limitador de velocidad, en el servidor o en una pasarela?
No hay una respuesta absoluta. Depende de la pila tecnológica de recursos de ingeniería, prioridades, objetivos, etc. Aquí mostraremos algunas directrices generales:

- Evalúe su pila tecnológica actual, como lenguaje de programación,
servicio de caché, etc. Asegúrese de que su lenguaje de programación actual es
eficiente para implementar la limitación de velocidad en el lado del servidor.

-Identifique el algoritmo de limitación de velocidad que se ajuste a las necesidades de su empresa. Cuando implementas todo en el lado del servidor, tiene el control total del algoritmo. Sin embargo, su elección puede verse limitada si utiliza una pasarela de terceros.

- Si ya ha utilizado una arquitectura de microservicios y ha incluido una pasarela de API en el diseño para realizar la autenticación, listas blancas de IP, etc., puede añadir un limitador de velocidad a la pasarela de API.

- Construir su propio servicio de limitación de velocidad lleva tiempo. Si no dispone de
recursos de ingeniería suficientes para implementar un limitador de velocidad, una pasarela de API comercial es una mejor opción.

# Algoritmos de limitación de velocidad

La limitación de velocidad puede implementarse utilizando diferentes algoritmos, y cada uno de ellos tiene sus pros y sus contras. Aunque este capítulo no se centra en
algoritmos, entenderlos a alto nivel ayuda a elegir el algoritmo o combinación de algoritmos que se ajuste a nuestros casos de uso. He aquí una lista de
algoritmos populares:

- Token bucket
  
- Cubo de fugas
  
- Contador de ventana fija

- Registro de ventanas deslizantes
  
- Contador de ventana móvil
  
# Algoritmo Token Bucket

El algoritmo token bucket es muy utilizado para limitar la velocidad. Es sencillo,
bien entendido y comúnmente utilizado por las empresas de Internet. Tanto Amazon
[5] y Stripe [6] utilizan este algoritmo para limitar sus peticiones API.

El algoritmo de token bucket funciona de la siguiente manera:

- Un token bucket es un contenedor que tiene una capacidad predefinida. Los tokens se
en el cubo a un ritmo preestablecido periódicamente. Una vez que el cubo está lleno, no se añaden más fichas. Como se muestra en la Figura 4-4, la capacidad del cubo es de 4 fichas.El rellenador pone 2 fichas en el cubo cada segundo. Una vez que el cubo esté lleno, las fichas adicionales rebosarán.

(Imagen)Un cuadro que contiene el juego, la tabla Descripción generada automáticamente

- Cada solicitud consume una ficha. Cuando llega una solicitud, se comprueba si
hay suficientes fichas en el cubo. La figura 4-5 explica cómo funciona.

- Si hay suficientes fichas, sacamos una ficha por cada solicitud y hacemos pasar la solicitud.

- Si no hay suficientes fichas, la solicitud se descarta.

(Mapa)Detalle de un mapa Descripción generada automáticamente

La Figura 4-6 ilustra cómo funcionan el consumo de fichas, la recarga y la lógica de limitación de velocidad. En este ejemplo, el tamaño del cubo de fichas es 4, y la tasa de recarga es de 4 por 1 minuto.

(Imagen)Primer plano de un texto sobre fondo blanco Descripción generada automáticamente

El algoritmo del cubo de fichas toma dos parámetros:

- Tamaño del cubo: número máximo de fichas que puede contener el cubo.
  
- Tasa de relleno: número de fichas que se introducen en el cubo cada segundo.
  
¿Cuántos cubos necesitamos? Esto varía y depende de las reglas de limitación de la tasa. He aquí algunos ejemplos.

- Suele ser necesario tener distintos buckets para distintos puntos finales de API. Por ejemplo, si a un usuario se le permite hacer 1 publicación por segundo, añadir
150 amigos por día, y como 5 mensajes por segundo, 3 cubos son necesarios para
cada usuario.

-Si tenemos que limitar las solicitudes en función de las direcciones IP, cada dirección IP requiere un cubo.

- Si el sistema permite un máximo de 10.000 peticiones por segundo, tiene sentido tener un cubo global compartido por todas las peticiones.
  
Ventajas:

- El algoritmo es fácil de implementar.
  
- Uso eficiente de la memoria.
  
- El cubo de peticiones permite una ráfaga de tráfico durante periodos cortos. Una petición puede pasar mientras queden tokens.
  
Contras:

- Dos parámetros del algoritmo son el tamaño del cubo y la tasa de rellenado de tokens.
Sin embargo, puede resultar difícil ajustarlos correctamente.

# Algoritmo de cubo con fugas

El algoritmo de cubo con fugas es similar al de cubo de tokens, excepto en que las peticiones se procesan a un ritmo fijo. Suele implementarse con una cola FIFO (primero en entrar, primero en salir). El algoritmo funciona de la siguiente manera: 

- Cuando llega una solicitud, el sistema comprueba si la cola está llena. Si no está
llena, la solicitud se añade a la cola.

- En caso contrario, se descarta.
  
- Las solicitudes se sacan de la cola y se procesan a intervalos regulares.
  
La figura 4-7 explica el funcionamiento del algoritmo.

(Mapa)Primer plano de un mapa Descripción generada automáticamente

El algoritmo Leaking Bucket toma los dos parámetros siguientes:

- Tamaño del cubo: es igual al tamaño de la cola. La cola contiene las solicitudes que
procesar a un ritmo fijo.

- Tasa de salida: define cuántas solicitudes pueden procesarse a una tasa fija, normalmente en segundos.

Shopify, una empresa de comercio electrónico, utiliza leaky buckets para limitar la tasa [7].

Ventajas:

- Eficiencia de memoria dado el tamaño limitado de la cola.
  
- Las solicitudes se procesan a un ritmo fijo, por lo que es adecuado para casos de uso
en los que se necesita una tasa de salida estable.

Contras:

- Una ráfaga de tráfico llena la cola de solicitudes antiguas y, si no se procesan a tiempo, las solicitudes recientes se verán afectadas por una limitación.
  
- Hay dos parámetros en el algoritmo. Puede que no sea fácil sintonizar ellos adecuadamente.

# Algoritmo de contador de ventana fija

El algoritmo de contador de ventana fija funciona de la siguiente manera:

- El algoritmo divide la línea de tiempo en ventanas de tiempo de tamaño fijo y asigna
un contador para cada ventana.

- Cada solicitud incrementa el contador en uno.
  
- Una vez que el contador alcanza el umbral predefinido, se descartan nuevas peticiones hasta que se inicia una nueva ventana temporal.

Utilicemos un ejemplo concreto para ver cómo funciona. En la Figura 4-8, la unidad
es de 1 segundo y el sistema permite un máximo de 3 peticiones por segundo. En cada ventana de segundos, si se reciben más de 3 peticiones, se descartan las peticiones adicionales, como se muestra en la figura 4-8.

(Captura)Captura de pantalla de un móvil Descripción generada automáticamente

Un problema importante de este algoritmo es que una ráfaga de tráfico en los bordes de
ventanas de tiempo podría hacer que pasasen más peticiones de la cuota permitida.
Considere el siguiente caso:

(Captura)Captura de pantalla de una publicación en redes sociales Descripción generada automáticamente.

En la Figura 4-9, el sistema permite un máximo de 5 peticiones por minuto, y
la cuota disponible se restablece en el minuto redondo para humanos. Como se ve
hay cinco solicitudes entre las 2:00:00 y las 2:01:00 y cinco solicitudes más
entre las 2:01:00 y las 2:02:00. En la ventana de un minuto entre las 2:00:30
y las 2:01:30, pasan 10 peticiones. Es decir, el doble de las permitidas.

Ventajas:

- Memoria eficiente.
  
- Fácil de entender.
  
- El restablecimiento de la cuota disponible al final de una ventana de tiempo unitaria se ajusta a ciertos casos de uso.

Contras:

- Los picos de tráfico en los extremos de una ventana pueden hacer que pasen más peticiones que la cuota permitida.
  
# Algoritmo de registro de ventana deslizante
Como se ha comentado anteriormente, el algoritmo de contador de ventana fija tiene un problema importante: permite que pasen más solicitudes en los bordes de una ventana. El algoritmo soluciona el problema. Funciona de la siguiente manera:

- El algoritmo registra las marcas de tiempo de las solicitudes. Las marcas de tiempo
normalmente se guardan en una caché, como los conjuntos ordenados de Redis [8].

- Cuando llega una nueva petición, elimina todas las marcas de tiempo desactualizadas.
Las marcas de tiempo obsoletas se definen como aquellas más antiguas que el inicio de la ventana de tiempo actual.

- Añada la marca de tiempo de la nueva solicitud al registro.
  
- Si el tamaño del registro es igual o inferior al recuento permitido, se acepta la solicitud. En caso contrario, se rechaza.
- 
Explicamos el algoritmo con un ejemplo, como se muestra en la Figura 4-10.

(Imagen)Un primer plano de texto sobre fondo blanco Descripción automáticamente
generado automáticamente.

En este ejemplo, el limitador de velocidad permite 2 solicitudes por minuto. Normalmente,
Las marcas de tiempo de Linux se almacenan en el registro.Sin embargo, en nuestro ejemplo se utiliza una representación del tiempo legible para el ser humano para una mejor legibilidad.

- El registro está vacío cuando llega una nueva petición a la 1:00:01. Por lo tanto, la solicitud está permitida.
  
- Cuando llega una nueva solicitud a las 1:00:30, se inserta la marca de tiempo 1:00:30 en el registro. Después de la inserción, el tamaño del registro es 2, no mayor que el recuento permitido.Por lo tanto, la solicitud está permitida.
  
- Una nueva solicitud llega a las 1:00:50, y la marca de tiempo se inserta en el registro.Tras la inserción, el tamaño del registro es 3, mayor que el tamaño 2 permitido.
Por lo tanto, esta solicitud se rechaza aunque la marca de tiempo permanece en el registro.

- A la 1:01:40 llega una nueva solicitud. Las solicitudes en el intervalo [1:00:40,1:01:40) están dentro del intervalo de tiempo más reciente, pero las solicitudes enviadas antes de la 1:00:40 están obsoletas. Dos marcas de tiempo obsoletas, 1:00:01 y 1:00:30, se eliminan del registro.Tras la operación de eliminación, el tamaño del registro pasa a ser 2; por lo tanto la solicitud es aceptada.
